<!doctype html>
<html lang=en>
<head>
    <meta charset=UTF-8>
    <meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel=icon href=data:,>
    <title>OpenCtrl Driving</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
        }
        * {
            user-select: none;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100dvh;
            width: 100dvw;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            background-color: #333;
            color: white;
        }
        main {
            flex: 1 1 auto;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        x-wheel {
            flex: 0 0 auto;
            width: 300px;
            height: 300px;
        }
        div {
            flex: 0 0 auto;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: black;
            color: white;
        }
    </style>
<head>
<body>
    <svg id="center-cross" width="100" height="100" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:10;">
        <line x1="50" y1="0" x2="50" y2="100" stroke="red" stroke-width="2" />
        <line x1="0" y1="50" x2="100" y2="50" stroke="red" stroke-width="2" />
    </svg>
    <svg id="touch-area-rect" style="position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:5;">
        <!-- The rect will be set by JS -->
    </svg>
    <script>
        // Helper function to send POST requests.
        function post(ip, path, body) {
            return fetch(`http://${ip}/${path}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
        }
        
        function updateTouchRect() {
            const minDim = Math.min(window.innerWidth, window.innerHeight);
            const rectSize = minDim * 0.8;
            const rectLeft = (window.innerWidth - rectSize) / 2;
            const rectTop = (window.innerHeight - rectSize) / 2;
            const svg = document.getElementById('touch-area-rect');
            svg.innerHTML = `<rect x="${rectLeft}" y="${rectTop}" width="${rectSize}" height="${rectSize}" 
                fill="rgba(0,0,0,0.05)" stroke="blue" stroke-width="2" rx="20" />`;
            // Save for event logic
            window._touchRect = {rectLeft, rectTop, rectWidth: rectSize, rectHeight: rectSize};
        }
        window.addEventListener('resize', updateTouchRect);
        updateTouchRect();

        function isInActiveRect(x, y) {
            const {rectLeft, rectTop, rectWidth, rectHeight} = window._touchRect;
            return (
                x >= rectLeft &&
                x <= rectLeft + rectWidth &&
                y >= rectTop &&
                y <= rectTop + rectHeight
            );
        }

        function calculatePointer(normalizedX, normalizedY) {
            // Map X-axis to joystick range (-127 to 127)
            const maxRange = 127;
            const joyX = Math.max(-maxRange, Math.min(maxRange, Math.round(normalizedX * maxRange)));

            // Map Y-axis to joystick Z and RZ (throttle and brake)
            // Note: A trigger is usually represented as a value from -127 to +127, where -127 is unpressed. Meanse the range is 255.
            let triggerL = -127; // Left Trigger (Throttle, unpressed)
            let triggerR = -127; // Right Trigger (Brake, unpressed)
            if (normalizedY > 0) {
                // Throttle
                triggerR = (normalizedY*255)-127;
            } else {
                // Brake
                triggerL = (-normalizedY*255)-127;
            }

            return {joyX, triggerL, triggerR};
        }

        let lastUpdate = 0;
        const minInterval = 50; // milliseconds between updates
        function normalizeToTouchArea(x, y) {
            const {rectLeft, rectTop, rectWidth, rectHeight} = window._touchRect;
            // Center of the touch area
            const centerX = rectLeft + rectWidth / 2;
            const centerY = rectTop + rectHeight / 2;
            // Normalize to -1..1 inside the touch area
            const normalizedX = (x - centerX) / (rectWidth / 2);
            const normalizedY = (centerY - y) / (rectHeight / 2); // Invert Y
            return {normalizedX, normalizedY};
        }

        document.addEventListener('pointermove', function(event) {
            if (!isInActiveRect(event.clientX, event.clientY)) return;

            const now = Date.now();
            if (now - lastUpdate < minInterval) return;
            lastUpdate = now;

            const {normalizedX, normalizedY} = normalizeToTouchArea(event.clientX, event.clientY);
            const {joyX, triggerL, triggerR} = calculatePointer(normalizedX, normalizedY);
            post('192.168.1.171', 'gamepad', { "x": joyX, "y": 0, "z": triggerL, "rz": triggerR, });
        }, { passive: false });
        document.addEventListener('pointerdown', function(event) {
            if (!isInActiveRect(event.clientX, event.clientY)) return;
            
            const {normalizedX, normalizedY} = normalizeToTouchArea(event.clientX, event.clientY);
            const {joyX, triggerL, triggerR} = calculatePointer(normalizedX, normalizedY);
            post('192.168.1.171', 'gamepad', { "x": joyX, "y": 0, "z": triggerL, "rz": triggerR, });
        }, { passive: false });
        document.addEventListener('pointerup', function(event) {
            // On pointer up, reset joystick to (0,0)
            post('192.168.1.171', 'gamepad', { "x": 0, "y": 0, "z": -127, "rz": -127, });
        }, { passive: false });
        // Prevent iOS magnification on long-touch.
        document.addEventListener('touchstart', function(e) { e.preventDefault(); }, { passive: false });
    </script>
</body>
</html>
